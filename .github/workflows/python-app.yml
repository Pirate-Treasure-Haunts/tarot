name: Build installers (Win EXE / macOS PKG / Linux DEB+RPM)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version string to embed (e.g. 1.0.0). If blank, uses short SHA."
        required: false
        default: ""

permissions:
  contents: read

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    env:
      APP_NAME: a-tarot-for-the-modern-age

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "APP_VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          else
            echo "APP_VERSION=0.0.0-${GITHUB_SHA::7}" >> $GITHUB_ENV
          fi

      - name: Ensure distribution docs exist
        shell: bash
        run: |
          test -f LICENSE.txt || (echo "Missing LICENSE.txt at repo root" && exit 1)
          test -f EULA.txt || (echo "Missing EULA.txt at repo root" && exit 1)
          test -f README_DIST.txt || (echo "Missing README_DIST.txt at repo root" && exit 1)
          test -f pull_cards.py || (echo "Missing pull_cards.py at repo root" && exit 1)
          test -f deck_data.json || (echo "Missing deck_data.json at repo root" && exit 1)

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PyInstaller
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build executable (PyInstaller)
        shell: bash
        run: |
          pyinstaller pull_cards.py \
            --name "${APP_NAME}" \
            --onefile \
            --clean \
            --noconfirm \
            --add-data "deck_data.json:."

      # ---------------- WINDOWS INSTALLER (Inno Setup) ----------------
      - name: Build executable (Windows, PyInstaller)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller

          # Clean any previous outputs
          if (Test-Path build) { Remove-Item -Recurse -Force build }
          if (Test-Path dist) { Remove-Item -Recurse -Force dist }
          if (Test-Path installers\windows\payload) { Remove-Item -Recurse -Force installers\windows\payload }

          # Build .exe
          python -m PyInstaller pull_cards.py `
            --name "a-tarot-for-the-modern-age" `
            --onefile `
            --clean `
            --noconfirm `
            --add-data "deck_data.json;."

          # Copy exe + docs into a *known* payload folder for Inno
          New-Item -ItemType Directory -Force -Path installers\windows\payload | Out-Null

          - name: Upload Windows installer artifact
           if: runner.os == 'Windows'
            uses: actions/upload-artifact@v4
                with:
              name: TarotSetup-Windows-${{ env.APP_VERSION }}
              path: installers/windows/out/*.exe
              if-no-files-found: error

          Copy-Item "dist\a-tarot-for-the-modern-age.exe" "installers\windows\payload\" -Force
          Copy-Item "deck_data.json" "installers\windows\payload\" -Force
          Copy-Item "LICENSE.txt" "installers\windows\payload\" -Force
          Copy-Item "EULA.txt" "installers\windows\payload\" -Force
          Copy-Item "README_DIST.txt" "installers\windows\payload\" -Force

          # Prove payload exists (and fail loudly if not)
          Write-Host "== payload contents =="
          Get-ChildItem installers\windows\payload -Force
          if (!(Test-Path "installers\windows\payload\a-tarot-for-the-modern-age.exe")) {
            Write-Error "Exe missing from installers\windows\payload\"
          }

      # ---------------- macOS PKG INSTALLER ----------------
      - name: Build macOS pkg
        if: runner.os == 'macOS'
        shell: bash
        run: |
          mkdir -p pkgroot/Applications/A\ Tarot\ For\ The\ Modern\ Age
          cp "dist/${APP_NAME}" "pkgroot/Applications/A Tarot For The Modern Age/${APP_NAME}"
          cp deck_data.json "pkgroot/Applications/A Tarot For The Modern Age/deck_data.json"
          cp LICENSE.txt EULA.txt README_DIST.txt "pkgroot/Applications/A Tarot For The Modern Age/"

          pkgbuild \
            --root pkgroot \
            --identifier com.ryomodular.tarot.pkg \
            --version "${APP_VERSION}" \
            --install-location / \
            tarot.pkg

          mkdir -p resources
          cp EULA.txt resources/EULA.txt

          productbuild \
            --distribution installers/macos/distribution.xml \
            --resources resources \
            --package-path . \
            "TarotInstaller-macOS-${APP_VERSION}.pkg"

      - name: Upload macOS pkg artifact
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: TarotInstaller-macOS-${{ env.APP_VERSION }}
          path: TarotInstaller-macOS-*.pkg
          if-no-files-found: error

      # ---------------- LINUX DEB + RPM ----------------
      - name: Install fpm (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential rpm
          sudo gem install --no-document fpm

      - name: Build DEB and RPM (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          mkdir -p pkgroot/usr/local/bin
          mkdir -p pkgroot/usr/share/doc/a-tarot-for-the-modern-age

          cp "dist/${APP_NAME}" "pkgroot/usr/local/bin/${APP_NAME}"
          cp LICENSE.txt EULA.txt README_DIST.txt "pkgroot/usr/share/doc/a-tarot-for-the-modern-age/"

          chmod 755 "pkgroot/usr/local/bin/${APP_NAME}"
          chmod 755 installers/linux/postinstall.sh installers/linux/prerm.sh

          fpm -s dir -t deb \
            -n a-tarot-for-the-modern-age \
            -v "${APP_VERSION}" \
            --license "Proprietary" \
            --maintainer "RYOModular" \
            --description "A Tarot For The Modern Age (desktop executable)" \
            --after-install installers/linux/postinstall.sh \
            --before-remove installers/linux/prerm.sh \
            -C pkgroot .

          fpm -s dir -t rpm \
            -n a-tarot-for-the-modern-age \
            -v "${APP_VERSION}" \
            --license "Proprietary" \
            --maintainer "RYOModular" \
            --description "A Tarot For The Modern Age (desktop executable)" \
            --after-install installers/linux/postinstall.sh \
            --before-remove installers/linux/prerm.sh \
            -C pkgroot .

      - name: Upload Linux package artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: TarotPackages-Linux-${{ env.APP_VERSION }}
          path: |
            *.deb
            *.rpm
          if-no-files-found: error
